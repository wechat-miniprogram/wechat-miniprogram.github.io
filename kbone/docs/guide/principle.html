<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>原理 | wechat-miniprogram / kbone</title>
    <meta name="description" content="Web 与小程序同构解决方案">
    
    
    <link rel="preload" href="/kbone/docs/assets/css/0.styles.0dc36e5d.css" as="style"><link rel="preload" href="/kbone/docs/assets/js/app.105b52d4.js" as="script"><link rel="preload" href="/kbone/docs/assets/js/3.1e982bd2.js" as="script"><link rel="preload" href="/kbone/docs/assets/js/4.2de33f1c.js" as="script"><link rel="prefetch" href="/kbone/docs/assets/js/10.c7a5162e.js"><link rel="prefetch" href="/kbone/docs/assets/js/11.83be97ea.js"><link rel="prefetch" href="/kbone/docs/assets/js/12.b1bd9851.js"><link rel="prefetch" href="/kbone/docs/assets/js/13.a8eafac8.js"><link rel="prefetch" href="/kbone/docs/assets/js/14.8de93255.js"><link rel="prefetch" href="/kbone/docs/assets/js/15.099edea0.js"><link rel="prefetch" href="/kbone/docs/assets/js/16.ac54ee66.js"><link rel="prefetch" href="/kbone/docs/assets/js/17.e63e01e3.js"><link rel="prefetch" href="/kbone/docs/assets/js/18.4a26d176.js"><link rel="prefetch" href="/kbone/docs/assets/js/5.671451ed.js"><link rel="prefetch" href="/kbone/docs/assets/js/6.f3f7ef3d.js"><link rel="prefetch" href="/kbone/docs/assets/js/7.6f29a708.js"><link rel="prefetch" href="/kbone/docs/assets/js/8.cdd85d7a.js"><link rel="prefetch" href="/kbone/docs/assets/js/9.8dc742eb.js"><link rel="prefetch" href="/kbone/docs/assets/js/vendors~docsearch.ca056f07.js">
    <link rel="stylesheet" href="/kbone/docs/assets/css/0.styles.0dc36e5d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/kbone/docs/" class="home-link router-link-active"><!----> <span class="site-name">wechat-miniprogram / kbone</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/kbone/docs/" class="nav-link">指南</a></div><div class="nav-item"><a href="/kbone/docs/config/" class="nav-link">配置</a></div><div class="nav-item"><a href="/kbone/docs/domextend/" class="nav-link">dom/bom 扩展 API</a></div><div class="nav-item"><a href="/kbone/docs/qa/" class="nav-link">Q&amp;A</a></div><div class="nav-item"><a href="/kbone/docs/changelog/" class="nav-link">更新日志</a></div><div class="nav-item"><a href="https://github.com/wechat-miniprogram/kbone" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/kbone/docs/" class="nav-link">指南</a></div><div class="nav-item"><a href="/kbone/docs/config/" class="nav-link">配置</a></div><div class="nav-item"><a href="/kbone/docs/domextend/" class="nav-link">dom/bom 扩展 API</a></div><div class="nav-item"><a href="/kbone/docs/qa/" class="nav-link">Q&amp;A</a></div><div class="nav-item"><a href="/kbone/docs/changelog/" class="nav-link">更新日志</a></div><div class="nav-item"><a href="https://github.com/wechat-miniprogram/kbone" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/kbone/docs/" class="sidebar-link">kbone 是什么？</a></li><li><a href="/kbone/docs/guide/quickstart.html" class="sidebar-link">快速上手</a></li><li><a href="/kbone/docs/guide/tutorial.html" class="sidebar-link">kbone 项目搭建流程</a></li><li><a href="/kbone/docs/guide/advanced.html" class="sidebar-link">进阶用法</a></li><li><a href="/kbone/docs/guide/principle.html" class="active sidebar-link">原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kbone/docs/guide/principle.html#微信小程序是什么？" class="sidebar-link">微信小程序是什么？</a></li><li class="sidebar-sub-header"><a href="/kbone/docs/guide/principle.html#方案设计" class="sidebar-link">方案设计</a></li><li class="sidebar-sub-header"><a href="/kbone/docs/guide/principle.html#实现" class="sidebar-link">实现</a></li></ul></li><li><a href="/kbone/docs/guide/optimize.html" class="sidebar-link">代码优化</a></li><li><a href="/kbone/docs/guide/suggest.html" class="sidebar-link">开发建议</a></li><li><a href="/kbone/docs/guide/develop.html" class="sidebar-link">贡献规范</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h1> <h2 id="微信小程序是什么？"><a href="#微信小程序是什么？" class="header-anchor">#</a> 微信小程序是什么？</h2> <p>微信小程序是一种全新的连接用户与服务的方式，它可以在微信内被便捷地获取和传播，同时具有出色的使用体验。小程序提供了一个简单、高效的应用开发框架和丰富的组件及API，帮助开发者在微信中开发具有原生 APP 体验的服务。</p> <p>小程序的技术底层依托于 Web 技术，和 Web 端开发相似却又不同。在 Web 中，开发者可以使用浏览器提供的 dom/bom api 来操作渲染内容，同时编写 js 脚本来执行页面逻辑；在小程序中渲染和逻辑则完全分离，开发者可以编写 js 脚本，但是无法直接调用 dom/bom api，渲染和逻辑的交互通过数据和事件来驱动，开发者可以不用在去关心渲染的细节。</p> <p><img src="/kbone/docs/assets/img/01.11cd5f0e.jpg" alt="小程序环境"></p> <p>如上所述，小程序的底层实现是封闭的，现有的 Web 代码无法直接在小程序环境里运行，对于有多端需求的项目来说代码的维护是一个难题，加一个功能或者改一个样式可能需要改动两套代码。因此，kbone 作为一套解决方案应运而生，用于支持让一个项目可以同时在 Web 端和小程序端被使用。</p> <h2 id="方案设计"><a href="#方案设计" class="header-anchor">#</a> 方案设计</h2> <p>方案设计有如下几个前提：</p> <ol><li>为了更好的复用组件，尽可能完整的支持 Web 端的特性</li> <li>在小程序端的渲染结果要尽可能接近 Web 端 h5 页面</li></ol> <p>在前提 1 的限制下，直接将 Web 端组件直接转换成小程序代码的方式不可取，因为这种做法会限制大部分 Web 端特性，而且在一些可实现特性的兼容方面也很难做得完美，所以必须将 Web 端框架（比如 vue、react 等）给完整引进来。这些 Web 端框架底层依赖了小程序里没有的 dom 接口，想要引入 Web 端框架，要么对其底层进行修改，要么提供适配器接口。为了方便开发维护，同时也为了尽可能避免引入难以预料的问题，准备以提供适配器的方式来支持。</p> <p><img src="data:image/png;base64,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" alt="方案设计"></p> <p>适配器可以理解是一棵在 appService 端运行的轻型 dom 树，它提供基础的 dom/bom api。appService 端和 webview 端的交互通过适配器来进行，Web 端框架和业务代码不直接触达和 webview 端的通信接口（如 setData 等接口）。</p> <p>dom 树本身是没有固定模式可循的，它的层级、dom 节点数量都是不固定的，没有办法用固定的 wxml 将其描述出来，因此这里使用了小程序自定义组件的自引用特性。</p> <p>自定义组件支持使用自己作为其子节点，也就是说可以用递归引用的方式来构造任意层级、任意节点数量的自定义组件树，所以可以将若干个 dom 节点映射成一个小程序的自定义组件，每一个自定义组件相当于描述出了 dom 树的一部分，然后将这些自定义组件拼接起来就可以描述出一棵完整的 dom 树。</p> <p><img src="/kbone/docs/assets/img/03.6d731e9c.jpg" alt="方案设计"></p> <p>如上图所述，虚线框将一棵 dom 树划分成五棵子树，每棵子树最多不超过三层。这个虚线框就可以理解成是一个自定义组件，每个自定义组件渲染一棵层级不超过三层的 dom 子树，然后将这些自定义组件拼接起来就相当于渲染出了一棵完整的 dom 树。</p> <h2 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h2> <p>根据上述方案实现出来的适配器包含两部分：负责提供 dom/bom api 的 js 库和负责渲染的自定义组件，也就是 kbone 中的 <strong>miniprogram-render</strong> 和 <strong>miniprogram-element</strong>，可以看到 kbone 最终生成的小程序代码里会依赖这两个 npm 包。除此之外还需要一个 webpack 插件来根据原始的 Web 端源码生成小程序代码，因为小程序代码包和 Web 端的代码不同，它有固定的结构，而这个插件就是 <strong>mp-webpack-plugin</strong>。</p> <p>miniprogram-render、miniprogram-element 和 mp-webpack-plugin 这三个包即是 kbone 的核心。mp-webpack-plugin 作为 webpack 插件，被 webpack 配置所依赖；前两个包则组成了适配器，被生成的小程序代码依赖。不过通常情况下用户不用管适配器是怎么被使用的，只要用户配置好 mp-webpack-plugin 插件，在执行构建时就会将使用适配器的代码生成出来，而后用户只需要走<a href="https://developers.weixin.qq.com/miniprogram/dev/devtools/npm.html" target="_blank" rel="noopener noreferrer">小程序使用 npm <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的流程将适配器安装构建到小程序目录即可。后续如果遇到要升级 kbone 的情况，也只要升级这三个包就可以了。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/kbone/docs/guide/advanced.html" class="prev">进阶用法</a></span> <span class="next"><a href="/kbone/docs/guide/optimize.html">代码优化</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/kbone/docs/assets/js/app.105b52d4.js" defer></script><script src="/kbone/docs/assets/js/3.1e982bd2.js" defer></script><script src="/kbone/docs/assets/js/4.2de33f1c.js" defer></script>
  </body>
</html>
